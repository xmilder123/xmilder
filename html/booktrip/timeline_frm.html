<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
</head>

<body>
    <section class="aui-content-padded">
        <div class="aui-card-list">
            <div class="aui-card-list-content-padded">
                <div class="aui-btn aui-btn-success" onclick="openScan2()">æ‰«ä¸€æ‰«ä½ å–å‡ºä¹¦ç±çš„ISBNç </div>
            </div>
            <div id="book_info" class="aui-card-list-footer">
                æš‚æ— è¯¥ä¹¦ä¿¡æ¯
            </div>
        </div>
    </section>


    <section class="aui-content">
        <div id="timeline_area" class="aui-timeline">
            <!-- <div class="aui-timeline-item-header">2017å¹´1æœˆ8æ—¥</div> -->
            <script id="timeline_list" type="text/x-dot-template">
                {{~ it : value : index }} {{? value.act == "æå‡º" }}
                <div class="aui-timeline-item">
                    <div class="aui-timeline-item-label-icon aui-bg-danger">
                        <i class="aui-iconfont aui-icon-like text-light"></i>
                    </div>
                    <div class="aui-timeline-item-inner">
                        <div class="aui-card-list">
                            <div class="aui-card-list-header aui-border-b">
                                <div>å¤§å¸ˆå…„ğŸŒ¹ğŸŒ¹ğŸŒ¹{{= value.user}}ğŸŒ¹ğŸŒ¹ğŸŒ¹äº{{= value.createdAt}}å°†è¯¥ä¹¦æ”¾å…¥{{= value.box}}æŸœï¼Œå®šä»·{{= value.price}}å…ƒ</div>
                                <i class="aui-iconfont aui-icon-star aui-text-danger"></i>
                            </div>
                            <div class="aui-card-list-content-padded">
                                <div class="aui-list-item-media" style="width:8rem"><img src="{{= value.photo.url}}"></div>
                            </div>
                            <div class="aui-card-list-footer aui-border-t aui-font-size-12">
                                ç•™è¨€ï¼šè¯·çˆ±æƒœä¹¦ç±
                            </div>
                        </div>
                    </div>
                </div>
                {{??}}
                <div class="aui-timeline-item">
                    <div class="aui-timeline-item-label aui-bg-info text-light">NO.{{=index}}</div>
                    <div class="aui-timeline-item-inner">
                        <div class="aui-card-list">
                            <div class="aui-card-list-header aui-border-b">
                                <div>{{=index+1}}å¸ˆå…„ğŸ€ğŸ€{{= value.user}}ğŸ€ğŸ€äº{{= value.createdAt}}å°†è¯¥ä¹¦{{= value.act}}</div>
                                <i class="aui-iconfont aui-icon-star aui-text-danger"></i>
                            </div>
                            <div class="aui-card-list-content-padded">
                                {{? value.act2 == "å½’è¿˜" }} {{=index+1}}å¸ˆå…„ğŸğŸ{{= value.user}}ğŸğŸäº{{= value.createdAt}}å°†è¯¥ä¹¦{{= value.act2}}åˆ°{{= value.box2}}æŸœï¼Œå®šä»·{{= value.price}}å…ƒ
                                <div class="aui-list-item-media" style="width:8rem"><img src="{{= value.photo.url}}"></div>{{?}}
                            </div>
                            <div class="aui-card-list-footer aui-border-t aui-font-size-12">
                                <div><i class="aui-iconfont aui-icon-note aui-font-size-14"></i> 666</div>
                                <div><i class="aui-iconfont aui-icon-laud aui-font-size-14"></i> 888</div>
                                <div><i class="aui-iconfont aui-icon-star aui-font-size-14"></i> 888</div>
                            </div>
                        </div>
                    </div>
                </div>
                {{?}} {{~}}
            </script>
        </div>
    </section>

</body>

<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/doT.js"></script>
<script type="text/javascript" src="../../script/aui-toast.js"></script>
<script type="text/javascript" src="../../script/m2m.js"></script>
<script type="text/javascript" src="../../script/account.js"></script>
<script type="text/javascript">
    var FNScanner;
    var book_info = $api.byId('book_info');

    var bookoid;
    var locate;
    var bkid;
    var book_name;
    var book_isbn;
    var account;

    function openScan2() {
        FNScanner.openScanner({
            autorotation: true
        }, function(ret, err) {
            console.log(JSON.stringify(ret));
            if (ret) {
                if (ret.content) {
                    book_isbn = ret.content;

                    query.createQuery(function(ret, err) {
                        if (ret && ret.qid) {
                            var queryId = ret.qid;
                            query.whereEqual({
                                qid: queryId,
                                column: 'isbn',
                                value: book_isbn
                            });
                            // query.whereEqual({
                            //     qid: queryId,
                            //     column: 'act',
                            //     value: 'å–å‡º'
                            // });
                            query.whereEqual({
                                qid: queryId,
                                column: 'user',
                                value: userinfo.name
                            });
                            query.include({
                                qid: queryId,
                                column: 'photo'
                            });
                            model.findAll({
                                class: "bookline",
                                qid: queryId
                            }, function(data, err) {
                                //  {"id":"599175d98ce793c369fdf229","bid":"100012174917","act":"å–å‡º","user":"xmilder","message":null,"name":"é«˜ç­‰æ•°å­¦è¾…å¯¼åŠä¹ é¢˜ç²¾è§£","price":"20","box":"hyit004-0","isbn":"9787563445042","act2":"å½’è¿˜","createdAt":"2017-08-14T10:05:13.919Z","updatedAt":"2017-09-06T15:22:44.941Z","photo":{"classify":"bookinfolib","owner":"xmilder","createdAt":"2017-09-01T01:33:29.229Z","updatedAt":"2017-09-01T01:33:29.229Z","id":"59a8b8e9ec09f42e0dff82d3","url":"http://af3f00fd16e3f1f81824.b0.upaiyun.com/apicloud/c68c9e472eaa54fceaa64887db27dddc.jpg","name":"frontcover","type":"image/jpeg","size":37337,"filename":"frontcover"},"book(uz*R*id)":null},
                                console.log(JSON.stringify(data));
                                if (data) {

                                    var templateText = $api.byId('timeline_list').innerHTML;
                                    var dot = doT.template(templateText);
                                    $api.byId('timeline_area').innerHTML = dot(data);

                                    //fnUpdatabookline(data);

                                    // bookoid = data[0]['id'];
                                    // book_name = data[0]['name'];
                                    // book_info.innerHTML = 'è¿™æ˜¯ä½ èŠ±äº†' + data[0]['price'] + 'å…ƒå–å‡ºçš„ã€Š' + book_name + 'ã€‹';
                                } else {
                                    console.log(JSON.stringify(error));
                                }
                            });
                        }
                    });
                }
            } else {
                alert('æ‰«æå¤±è´¥ï¼Œè¯·é‡æ–°æ‰«æ');
            }
        });
    }

    var query;
    var model;

    apiready = function() {
        FNScanner = api.require('FNScanner');
        query = api.require('query');
        model = api.require('model');
        get_base_info();
        // if (logined == 'true') {
        //     account = ;
        //     school = schoolinfo;
        // }

    };

    function fnUpdatabookline(data_) {
        var list = $api.byId('timebookline');
        // 1. ç¼–è¯‘æ¨¡æ¿å‡½æ•°
        var tempFn = doT.template($api.byId('template').innerHTML);
        // 2. å¤šæ¬¡ä½¿ç”¨æ¨¡æ¿å‡½æ•°
        var resultText = tempFn(data_);
        $api.html(list, resultText);
    }
</script>

</html>
